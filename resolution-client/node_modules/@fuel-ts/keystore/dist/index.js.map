{"version":3,"sources":["../src/index.ts","../src/aes-ctr.ts","../src/universal-crypto.ts","../src/randomBytes.ts","../src/aes-ctr-node.ts","../src/aes-ctr-web.ts","../src/keystore.ts"],"sourcesContent":["export * from './keystore';\n","import { arrayify } from '@ethersproject/bytes';\nimport { pbkdf2 } from '@ethersproject/pbkdf2';\n\nimport { strategy } from './universal-crypto';\n\nexport interface Keystore {\n  data: string;\n  iv: string;\n  salt: string;\n}\n\nexport function bufferFromString(\n  string: string,\n  encoding: 'utf-8' | 'base64' = 'base64'\n): Uint8Array {\n  if (strategy === 'Node') {\n    return Buffer.from(string, encoding);\n  }\n  if (encoding === 'utf-8') {\n    return new TextEncoder().encode(string);\n  }\n\n  return new Uint8Array(\n    atob(string)\n      .split('')\n      .map((c) => c.charCodeAt(0))\n  );\n}\n\nexport function stringFromBuffer(\n  buffer: Uint8Array,\n  encoding: 'utf-8' | 'base64' = 'base64'\n): string {\n  if (strategy === 'Node') {\n    return Buffer.from(buffer).toString(encoding);\n  }\n\n  return btoa(String.fromCharCode.apply(null, new Uint8Array(buffer) as unknown as number[]));\n}\n\n/**\n * Generate a pbkdf2 key from a password and random salt\n */\nexport function keyFromPassword(password: string, saltBuffer: Uint8Array): Uint8Array {\n  const passBuffer = bufferFromString(String(password).normalize('NFKC'), 'utf-8');\n  const key = pbkdf2(passBuffer, saltBuffer, 100000, 32, 'sha256');\n\n  return arrayify(key);\n}\n","import type { createCipheriv, createDecipheriv } from 'crypto';\n\ntype UniversalCrypto = {\n  getRandomValues: (length: number) => Uint8Array;\n  randomBytes: (length: number) => Uint8Array;\n  subtle: SubtleCrypto;\n  createCipheriv: typeof createCipheriv;\n  createDecipheriv: typeof createDecipheriv;\n};\nlet selectedCrypto;\nlet selectedStrategy: 'Node' | 'Web' = 'Node';\n\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore\nif (typeof globalThis !== 'undefined' && globalThis.crypto) {\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  // @ts-ignore\n  selectedCrypto = globalThis.crypto;\n  selectedStrategy = 'Web';\n}\n\nif (!selectedCrypto && typeof require === 'function') {\n  try {\n    // eslint-disable-next-line global-require\n    selectedCrypto = require('crypto');\n    selectedStrategy = 'Node';\n  } catch (error) {\n    // eslint-disable-next-line no-console\n    console.error('keystore expects a standard Web browser or Node environment.', error);\n  }\n}\n\nexport const crypto: UniversalCrypto = selectedCrypto;\nexport const strategy = selectedStrategy;\n","import { crypto, strategy } from './universal-crypto';\n\nexport const randomBytes = (length: number) =>\n  strategy === 'Node'\n    ? crypto.randomBytes(length)\n    : crypto.getRandomValues(new Uint8Array(length) as unknown as number);\n","import type { Keystore } from './aes-ctr';\nimport { bufferFromString, stringFromBuffer, keyFromPassword } from './aes-ctr';\nimport { randomBytes } from './randomBytes';\nimport { crypto } from './universal-crypto';\n\nconst ALGORITHM = 'aes-256-ctr';\n\n/**\n * Encrypts a data object that can be any serializable value using\n * a provided password.\n *\n * @returns Promise<Keystore> object\n */\nexport async function encrypt<T>(password: string, data: T): Promise<Keystore> {\n  const iv = randomBytes(16);\n  const salt = randomBytes(32);\n  const secret = keyFromPassword(password, salt);\n  const dataBuffer = Uint8Array.from(Buffer.from(JSON.stringify(data), 'utf-8'));\n\n  const cipher = await crypto.createCipheriv(ALGORITHM, secret, iv);\n  let cipherData = cipher.update(dataBuffer);\n  cipherData = Buffer.concat([cipherData, cipher.final()]);\n\n  return {\n    data: stringFromBuffer(cipherData),\n    iv: stringFromBuffer(iv),\n    salt: stringFromBuffer(salt),\n  };\n}\n\n/**\n * Given a password and a keystore object, decrypts the text and returns\n * the resulting value\n */\nexport async function decrypt<T>(password: string, keystore: Keystore): Promise<T> {\n  const iv = bufferFromString(keystore.iv);\n  const salt = bufferFromString(keystore.salt);\n  const secret = keyFromPassword(password, salt);\n  const encryptedText = bufferFromString(keystore.data);\n\n  const decipher = await crypto.createDecipheriv(ALGORITHM, secret, iv);\n  const decrypted = decipher.update(encryptedText);\n  const deBuff = Buffer.concat([decrypted, decipher.final()]);\n  const decryptedData = Buffer.from(deBuff).toString('utf-8');\n\n  try {\n    return JSON.parse(decryptedData);\n  } catch {\n    throw new Error('Invalid credentials');\n  }\n}\n","import type { Keystore } from './aes-ctr';\nimport { bufferFromString, stringFromBuffer, keyFromPassword } from './aes-ctr';\nimport { randomBytes } from './randomBytes';\nimport { crypto } from './universal-crypto';\n\nconst ALGORITHM = 'AES-CTR';\n\n/**\n * Encrypts a data object that can be any serializable value using\n * a provided password.\n *\n * @returns Promise<Keystore> object\n */\nexport async function encrypt<T>(password: string, data: T): Promise<Keystore> {\n  const iv = randomBytes(16);\n  const salt = randomBytes(32);\n  const secret = keyFromPassword(password, salt);\n  const dataString = JSON.stringify(data);\n  const dataBuffer = bufferFromString(dataString, 'utf-8');\n  const alg = {\n    name: ALGORITHM,\n    counter: iv,\n    length: 64,\n  };\n  const key = await crypto.subtle.importKey('raw', secret, alg, false, ['encrypt']);\n  const encBuffer = await crypto.subtle.encrypt(alg, key, dataBuffer);\n\n  return {\n    data: stringFromBuffer(encBuffer),\n    iv: stringFromBuffer(iv),\n    salt: stringFromBuffer(salt),\n  };\n}\n\n/**\n * Given a password and a keystore object, decrypts the text and returns\n * the resulting value\n */\nexport async function decrypt<T>(password: string, keystore: Keystore): Promise<T> {\n  const iv = bufferFromString(keystore.iv);\n  const salt = bufferFromString(keystore.salt);\n  const secret = keyFromPassword(password, salt);\n  const encryptedText = bufferFromString(keystore.data);\n\n  const alg = {\n    name: ALGORITHM,\n    counter: iv,\n    length: 64,\n  };\n  const key = await crypto.subtle.importKey('raw', secret, alg, false, ['decrypt']);\n\n  const ptBuffer = await crypto.subtle.decrypt(alg, key, encryptedText);\n  const decryptedData = new TextDecoder().decode(ptBuffer);\n\n  try {\n    return JSON.parse(decryptedData);\n  } catch {\n    throw new Error('Invalid credentials');\n  }\n}\n","import type { Keystore } from './aes-ctr';\nimport { encrypt as encNode, decrypt as decNode } from './aes-ctr-node';\nimport { encrypt as encWeb, decrypt as decWeb } from './aes-ctr-web';\nimport { strategy } from './universal-crypto';\n\nexport type { Keystore } from './aes-ctr';\nexport { keyFromPassword, bufferFromString, stringFromBuffer } from './aes-ctr';\nexport { randomBytes } from './randomBytes';\n\n/**\n * Encrypts a data object that can be any serializable value using\n * a provided password.\n *\n * @returns Promise<Keystore> Keystore object\n */\nexport async function encrypt<T>(password: string, data: T): Promise<Keystore> {\n  return strategy === 'Node' ? encNode<T>(password, data) : encWeb<T>(password, data);\n}\n\n/**\n * Given a password and a keystore object, decrypts the text and returns\n * the resulting value\n *\n *  @returns Promise<T> T object\n */\nexport async function decrypt<T>(password: string, keystore: Keystore): Promise<T> {\n  return strategy === 'Node' ? decNode<T>(password, keystore) : decWeb<T>(password, keystore);\n}\n"],"mappings":"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","names":["src_exports","__export","bufferFromString","decrypt","encrypt","keyFromPassword","randomBytes","stringFromBuffer","__toCommonJS","import_bytes","import_pbkdf2","selectedCrypto","selectedStrategy","error","crypto","strategy","bufferFromString","string","encoding","strategy","c","stringFromBuffer","buffer","keyFromPassword","password","saltBuffer","passBuffer","key","randomBytes","length","strategy","crypto","ALGORITHM","encrypt","password","data","iv","randomBytes","salt","secret","keyFromPassword","dataBuffer","cipher","crypto","cipherData","stringFromBuffer","decrypt","keystore","bufferFromString","encryptedText","decipher","decrypted","deBuff","decryptedData","ALGORITHM","encrypt","password","data","iv","randomBytes","salt","secret","keyFromPassword","dataString","dataBuffer","bufferFromString","alg","key","crypto","encBuffer","stringFromBuffer","decrypt","keystore","encryptedText","ptBuffer","decryptedData","encrypt","password","data","strategy","decrypt","keystore"]}